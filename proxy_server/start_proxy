#!/bin/sh

set -x  # Print each command before executing

# Get the port from Heroku
PORT=${PORT:-8000}
echo "Using PORT: $PORT"

# Ensure auth token is set
if [ -z "$CONFIGPROXY_AUTH_TOKEN" ]; then
    echo "Error: CONFIGPROXY_AUTH_TOKEN must be set"
    exit 1
fi
echo "Auth token is set"

# Print configurable-http-proxy version
echo "CHP version:"
configurable-http-proxy --version

# Print help to see available options
echo "CHP help:"
configurable-http-proxy --help

# Start configurable-http-proxy in the background
echo "Starting configurable-http-proxy..."
configurable-http-proxy \
    --port 8000 \
    --api-port 8001 \
    --default-target http://127.0.0.1:8000 \
    --error-target http://127.0.0.1:8000/hub/error \
    --api-path /api \
    --log-level debug &
PROXY_PID=$!
echo "Configurable-http-proxy started with PID: $PROXY_PID"

# Wait a moment for the proxy to start
sleep 2

# Check if proxy is running
if ! kill -0 $PROXY_PID 2>/dev/null; then
    echo "Error: configurable-http-proxy failed to start"
    exit 1
fi

# Replace PORT in nginx config
echo "Configuring nginx..."
sed -i "s/\$PORT/$PORT/g" /etc/nginx/nginx.conf

# Start nginx in the foreground
echo "Starting nginx..."
nginx -g 'daemon off;'

chmod +x start_proxy
