#!/bin/sh

# Get the port from Heroku
PORT=${PORT:-8000}

# Ensure auth token is set
if [ -z "$CONFIGPROXY_AUTH_TOKEN" ]; then
    echo "Error: CONFIGPROXY_AUTH_TOKEN must be set"
    exit 1
fi

# Start configurable-http-proxy in the background
configurable-http-proxy \
    --port 8000 \
    --api-port 8001 \
    --auth-token "$CONFIGPROXY_AUTH_TOKEN" \
    --default-target http://127.0.0.1:8000 \
    --error-target http://127.0.0.1:8000/hub/error \
    --log-level debug &

# Replace PORT in nginx config
sed -i "s/\$PORT/$PORT/g" /etc/nginx/nginx.conf

# Start nginx in the foreground
nginx

chmod +x start_proxy
