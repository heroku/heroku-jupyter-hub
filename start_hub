#!/usr/bin/env bash

# heroku will override $PS1 when specified as a config var, so we'll set it here to make the jupyter
# terminal interface a little prettier:
export PS1='\[\033[01;34m\]\w\[\033[00m\]\$'

echo "Archiving proxy server files for proxy build blob..."
export PROXY_BLOB='proxy_server/proxy_server_app.tar.gz'
tar -czf $PROXY_BLOB proxy_server/*
echo "Blob created"

echo "Creating app for proxy server..."
python3 create_proxy.py
echo "Proxy server app created"

echo "Connecting to database"
python3 connect_db.py
if [ $? -ne 0 ]; then
    echo "PROXY_PORT value not found."
    exit 1
else
    export PROXY_PORT=$(cat proxy_port.txt)
    echo "PROXY_PORT = $PROXY_PORT"
fi

echo "Waiting for proxy app to be ready..."
# More robust wait mechanism with timeout
max_attempts=30
attempt=1
while [ $attempt -le $max_attempts ]; do
    if [ -z "$PROXY_WEB_URL" ]; then
        echo "Waiting for PROXY_WEB_URL to be set (attempt $attempt/$max_attempts)..."
        sleep 2
        attempt=$((attempt + 1))
    else
        echo "PROXY_WEB_URL is set to: $PROXY_WEB_URL"
        break
    fi
done

if [ -z "$PROXY_WEB_URL" ]; then
    echo "Error: PROXY_WEB_URL not set after waiting. Exiting."
    exit 1
fi

echo "Starting Jupyterhub..."
exec jupyterhub --ConfigurableHTTPProxy.api_url="${PROXY_WEB_URL}:${PROXY_PORT}" --debug
#exec jupyterhub