#!/usr/bin/env bash

# heroku will override $PS1 when specified as a config var, so we'll set it here to make the jupyter
# terminal interface a little prettier:
export PS1='\[\033[01;34m\]\w\[\033[00m\]\$'

echo "Archiving proxy server files for proxy build blob..."
export PROXY_BLOB='proxy_server/proxy_server_app.tar.gz'
tar -czf $PROXY_BLOB proxy_server/*
echo "Blob created"

echo "Checking proxy server..."
if ! heroku apps:info -a "$PROXY_NAME" &>/dev/null; then
    echo "Creating proxy server app..."
    heroku create "$PROXY_NAME"
fi

echo "Setting proxy server config vars..."
heroku config:set \
    APP_NAME="$PROXY_NAME" \
    HUB_APP_NAME="$APP_NAME" \
    HUB_WEB_URL="$WEB_URL" \
    PROXY_WEB_URL="https://$PROXY_NAME.herokuapp.com/" \
    CONFIGPROXY_AUTH_TOKEN="$CONFIGPROXY_AUTH_TOKEN" \
    -a "$PROXY_NAME"

echo "Starting Jupyterhub..."
exec jupyterhub --debug